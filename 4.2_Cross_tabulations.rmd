```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, 
                      message = FALSE,
                      cache = TRUE, 
                      cache.path = "cache/4.2/")
```

# 4.2 Cross-tabulations {-}

Together, this module provides a comprehensive and well-structured estimation of the religious distribution among the Ethiopian population aged 10 and above, using ESS4 microdata and accounting for the complex survey design. Through proportions and totals, it reveals patterns of religious affiliation at the national level, by region, and by area type (urban/rural). The resulting tables allow for accurate interpretation and clear comparisons across geographic and social groups.

### Prepare the work environment {-}

This block sets up the working environment to analyze data from Section 1 of the **ESS4** household questionnaire. After clearing the memory and loading the required libraries, the corresponding dataset is imported, and the **survey design** is defined. It includes stratification by region and area type (urban/rural), identification of primary sampling units (`ea_id`), and use of adjusted sampling weights (`pw_w4`). This design ensures that subsequent analyses correctly reflect the complex survey structure and produce representative estimates. A summary of the design is printed at the end to verify its proper specification.


```{r}
#------------------------------------------------------------------------------#
#                           Cleaning R Environment                             #
#------------------------------------------------------------------------------#

rm(list = ls())
gc()

#------------------------------------------------------------------------------#
#                                Libraries                                     #
#------------------------------------------------------------------------------#

library(tidyverse)
library(survey)
library(srvyr)
library(data.table)
library(magrittr)
library(haven)
library(stringr)
library(tidyr)
library(knitr)
library(kableExtra)
library(convey)

# Ensure select function from dplyr is used explicitly
select <- dplyr::select

#------------------------------------------------------------------------------#
#                        Setting the RAM Memory Limit                          #
#------------------------------------------------------------------------------#

memory.limit(250000000)

#------------------------------------------------------------------------------#
#                           Loading Datasets                                   #
#------------------------------------------------------------------------------#

options(survey.lonely.psu = "fail") 
HH_data <- read_sav("data/data_ESS4/sect1_hh_w4.sav")

#------------------------------------------------------------------------------#
#                         Defining Survey Design                              #
#------------------------------------------------------------------------------#

ESS4_design <- HH_data %>%
  mutate(strata = paste0(saq01, "_", saq14)) %>%
  as_survey_design(
    ids = ea_id,
    # Primary sampling unit identifier (EA)
    strata = strata,
    # Stratification by region (saq01) and urban/rural zone (saq14)
    weights = pw_w4,
    # Final adjusted weight
    nest = TRUE
  )

options(survey.lonely.psu = "fail")
summary(ESS4_design)

```
### Processing Variables for Analysis  {-}

This block processes the variables needed for the analysis. It converts **sex** (`s1q02`) and **religion** (`s1q08`) into factors and recodes less frequent religion categories—such as "PEGAN", "TRADITIONAL", "WAKEFETA", "OTHER (SPECIFY)", and missing values—into a consolidated `"OTHER"` group. Additionally, the dataset is filtered to retain only individuals **aged 10 years or older** (`s1q03a >= 10`), ensuring that the analysis focuses on the population most likely to engage in social or economic activities.

```{r}
#------------------------------------------------------------------------------#
#                   Processing Variables for Analysis                         #
#------------------------------------------------------------------------------#

ESS4_design <- ESS4_design %>%
  mutate(
    sexo = as_factor(s1q02),
    religion = as_factor(s1q08),
    religion = case_when(
      religion %in% c("6. PEGAN", "5. TRADITIONAL", "8. OTHER (SPECIFY)",
                      "7. WAKEFETA") |
        is.na(religion) ~ "OTHER",
      TRUE ~ religion
    )
  ) %>%
  filter(s1q03a >= 10)

```

### Estimating Proportions and Totals by Religion {-}

This block estimates the religious distribution of the population aged 10 and above, computing proportions and total population counts using the complex survey design. First, estimates are calculated by administrative region (`saq01`) and religion. Then, a national-level estimate is generated by grouping the entire sample under "ETHIOPIA". Lastly, the same indicators are estimated by urban and rural areas (`saq14`). For each region or area and religion combination, the output includes the estimated proportion (`P_hat`) and the population total (`T_hat`), along with standard errors and coefficients of variation—ensuring both accurate interpretation and comparative analysis.

```{r}
#------------------------------------------------------------------------------#
#               Estimating Proportions and Totals by Religion                 #
#------------------------------------------------------------------------------#

# Estimates by region
tab_01_region <- ESS4_design %>%
  group_by(Region = as_factor(saq01), religion) %>%
  summarise(P_hat = survey_mean(vartype = c("se", "cv")),
            T_hat = survey_total(vartype = c("se", "cv")))

tab_01_region_margin <- ESS4_design %>%
  group_by(Region = as_factor(saq01)) %>%
  summarise(P_hat = survey_mean(vartype = c("se", "cv")),
            T_hat = survey_total(vartype = c("se", "cv")))

# National estimates
tab_01_tot <- ESS4_design %>%
  group_by(Region = "ETHIOPIA", religion) %>%
  summarise(P_hat = survey_mean(vartype = c("se", "cv")),
            T_hat = survey_total(vartype = c("se", "cv")))

# Estimates by urban/rural zones
tab_01_zone <- ESS4_design %>%
  group_by(Region = as_factor(saq14), religion) %>%
  summarise(P_hat = survey_mean(vartype = c("se", "cv")),
            T_hat = survey_total(vartype = c("se", "cv")))

tab_01_zone_margin <- ESS4_design %>%
  group_by(Region = as_factor(saq14)) %>%
  summarise(P_hat = survey_mean(vartype = c("se", "cv")),
            T_hat = survey_total(vartype = c("se", "cv")))
```

### Formatting and Displaying Cross-tabulation Tables {-}

This block displays the final table of religious affiliation proportions, reorganized for clarity and comparative analysis. It combines estimates by region, area (urban/rural), and national level, then selects the estimated proportion (`P_hat`) and religion, and reshapes the data into wide format. The proportions are expressed as percentages rounded to one decimal place. Finally, the table is filtered to show only the most relevant religious groups: Orthodox, Catholic, Protestant, Muslim, and Other. This simplified presentation is ideal for technical reports or visualizations that require a clear view of differences across geographic or social groups.


```{r, echo=TRUE,eval=FALSE}
#------------------------------------------------------------------------------#
#                  Formatting and Displaying Cross-tabulation Tables          #
#------------------------------------------------------------------------------#

# Proportions table
temp1 <- bind_rows(tab_01_region, tab_01_zone, tab_01_tot) %>%
  select(P_hat, religion) %>%
  mutate(P_hat = round(P_hat * 100, 1)) %>%
  pivot_wider(
    names_from = religion,
    values_from = P_hat,
    values_fill = list(P_hat = 0)
  ) %>% 
  left_join(bind_rows(tab_01_region_margin,tab_01_zone_margin) %>% 
               transmute(Region, P_hat = round(P_hat * 100, 1)),
             by = "Region")

temp1 %>%
  select(
    Region,
    Orthodox = "1. ORTHODOX",
    Catholic = "2. CATHOLIC",
    Protestant = "3. PROTESTANT",
    Muslim = "4. MUSLEM",
    Other = OTHER,
    P_hat
  ) 
```


```{r, echo=FALSE, eval=TRUE}
# Proportions table
temp1 <- bind_rows(tab_01_region, tab_01_zone, tab_01_tot) %>%
  select(P_hat, religion) %>%
  mutate(P_hat = round(P_hat * 100, 1)) %>%
  pivot_wider(
    names_from = religion,
    values_from = P_hat,
    values_fill = list(P_hat = 0)
  ) %>% 
  left_join(bind_rows(tab_01_region_margin,tab_01_zone_margin) %>% 
               transmute(Region, P_hat = round(P_hat * 100, 1)),
             by = "Region")

temp1 %>%
  select(
    Region,
    Orthodox = "1. ORTHODOX",
    Catholic = "2. CATHOLIC",
    Protestant = "3. PROTESTANT",
    Muslim = "4. MUSLEM",
    Other = OTHER,
    P_hat
  ) %>%  kable(format = "html") %>%
  kable_styling(full_width = FALSE)
```

This block generates and formats a table of absolute population sizes by religious affiliation, based on the survey design. Using the combined results by region, area (urban/rural), and national level, it selects the estimated population totals (`T_hat`) and the religion variable. The values are rounded and reshaped into a wide-format table, with religions as columns. The final table displays only the main categories: Orthodox, Catholic, Protestant, Muslim, and Other. This output provides an estimate of the number of individuals aged 10 and above affiliated with each religion, disaggregated by region or area type.


```{r, echo=TRUE,eval=FALSE}

# Absolute Sizes table
temp2 <- bind_rows(tab_01_region, tab_01_zone, tab_01_tot) %>%
  select(T_hat, religion) %>%
  mutate(T_hat = round(T_hat)) %>%
  pivot_wider(
    names_from = religion,
    values_from = T_hat,
    values_fill = list(T_hat = 0)
  ) %>% 
  left_join(bind_rows(tab_01_region_margin,tab_01_zone_margin) %>% 
               transmute(Region, T_hat = round(T_hat)),
             by = "Region")

temp2 %>%
  select(
    Region,
    Orthodox = "1. ORTHODOX",
    Catholic = "2. CATHOLIC",
    Protestant = "3. PROTESTANT",
    Muslim = "4. MUSLEM",
    Other = OTHER,
    T_hat
  ) 


```


```{r, echo=FALSE, eval=TRUE}

# Absolute Sizes table
temp2 <- bind_rows(tab_01_region, tab_01_zone, tab_01_tot) %>%
  select(T_hat, religion) %>%
  mutate(T_hat = round(T_hat)) %>%
  pivot_wider(
    names_from = religion,
    values_from = T_hat,
    values_fill = list(T_hat = 0)
  ) %>% 
  left_join(bind_rows(tab_01_region_margin,tab_01_zone_margin) %>% 
               transmute(Region, T_hat = round(T_hat)),
             by = "Region")

temp2 %>%
  select(
    Region,
    Orthodox = "1. ORTHODOX",
    Catholic = "2. CATHOLIC",
    Protestant = "3. PROTESTANT",
    Muslim = "4. MUSLEM",
    Other = OTHER,
    T_hat
  ) %>%  kable(format = "html") %>%
  kable_styling( full_width = FALSE)

```

