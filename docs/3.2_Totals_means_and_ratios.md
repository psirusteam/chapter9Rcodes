

# 3.2 Totals, means and ratios {-}


### Prepare the work environment {-}

This block resets the working environment and loads the necessary packages to continue with data processing and survey analysis in a new section. This structure ensures that each module of the analysis can be executed independently, promoting reproducibility and avoiding conflicts with previous sessions.


``` r
#------------------------------------------------------------------------------#
#                           Cleaning R Environment                             #
#------------------------------------------------------------------------------#

rm(list = ls())
gc()
```

```
##          used (Mb) gc trigger (Mb) max used (Mb)
## Ncells 542333 29.0    1219280 65.2   660485 35.3
## Vcells 955470  7.3    8388608 64.0  1770406 13.6
```

``` r
#------------------------------------------------------------------------------#
#                                Libraries                                     #
#------------------------------------------------------------------------------#

library(tidyverse)
library(survey)
library(srvyr)
library(data.table)
library(magrittr)
library(haven)
library(stringr)
library(tidyr)
library(knitr)
library(kableExtra)

# Ensure select function from dplyr is used explicitly
select <- dplyr::select

#------------------------------------------------------------------------------#
#                        Setting the RAM Memory Limit                          #
#------------------------------------------------------------------------------#

memory.limit(250000000)
```

```
## [1] Inf
```

This block loads data from section 7b of the household questionnaire, related to expenditures on nonfood items, and calculates the total expenditure per household. It then defines the survey design using the same stratification structure and primary sampling units as in previous sections, in order to apply the adjusted weights in the analysis. This step is essential to produce representative estimates of expenditure and its distribution across households.


``` r
#------------------------------------------------------------------------------#
#                           Loading Datasets                                   #
#------------------------------------------------------------------------------#

HH_data <- read_sav("data/data_ESS4/sect7b_hh_w4_v2.sav")

#------------------------------------------------------------------------------#
#                Calculating Ratio of Expenditures                            #
#------------------------------------------------------------------------------#

# Processing data
HH_data <- HH_data %>%
  mutate(expenditure = ifelse(s7q03 == 2, 0, s7q04)) %>%
  group_by(household_id) %>%
  mutate(total_expenditure = sum(expenditure, na.rm = TRUE))

# Defining the survey design
ESS4_design <- HH_data %>%
  mutate(strata = paste0(saq01, "_", saq14)) %>%
  as_survey_design(
    ids = ea_id,
    # Primary sampling unit identifier (EA)
    strata = strata,
    # Stratification by region (saq01) and urban/rural zone (saq14)
    weights = pw_w4,
    # Final adjusted weight
    nest = TRUE
  )

options(survey.lonely.psu = "fail")
summary(ESS4_design)
```

```
## Stratified 1 - level Cluster Sampling design (with replacement)
## With (535) clusters.
## Called via srvyr
## Probabilities:
##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
## 3.932e-05 1.997e-04 7.680e-04 2.814e-03 4.164e-03 1.317e-01 
## Stratum Sizes: 
##             1_1  1_2 12_1 12_2 13_1 13_2 14_2 15_1 15_2  2_1  2_2  3_1  3_2
## obs        4323 3113 2145 3300 2090 3960 8558 1760 4609 3289 2475 5269 2981
## design.PSU   35   19   19   20   18   24   52   14   28   28   15   43   18
## actual.PSU   35   19   19   20   18   24   52   14   28   28   15   43   18
##             4_1  4_2  5_1  5_2  6_1  6_2  7_1  7_2
## obs        4983 3300 3905 2805 1859 2145 4642 2959
## design.PSU   43   20   35   17   16   13   40   18
## actual.PSU   43   20   35   17   16   13   40   18
## Data variables:
##  [1] "household_id"      "item_cd_12months"  "ea_id"            
##  [4] "saq14"             "pw_w4"             "saq01"            
##  [7] "saq02"             "saq03"             "saq04"            
## [10] "saq05"             "saq06"             "saq07"            
## [13] "saq08"             "s7q03"             "s7q04"            
## [16] "expenditure"       "total_expenditure" "strata"
```

### Estimation of totals and means {-}

This block estimates the total expenditure and the average expenditure per household on nonfood items, disaggregated by item type. Using the previously defined survey design, the estimates are calculated along with their corresponding precision measures: standard error and coefficient of variation. The results are then rounded and displayed in a readable table to facilitate analysis and interpretation.


``` r
#------------------------------------------------------------------------------#
# Estimation of totals and means
#------------------------------------------------------------------------------#

tab_02 <- ESS4_design %>%   
  group_by(item = item_cd_12months) %>%
  summarise(
    T_hat = survey_total(expenditure, na.rm = TRUE, vartype = c("se", "cv")),
    M_hat = survey_mean(expenditure, na.rm = TRUE, vartype = c("se", "cv"))
  )

tab_02 %>%
  transmute(
    item = as_factor(item),
    T_hat = round(T_hat),
    T_hat_cv = round(T_hat_cv * 100, 2),
    M_hat = round(M_hat),
    M_hat_cv = round(M_hat_cv * 100, 2)
  ) %>% data.frame()
```



``` r
tab_02 <- ESS4_design %>%   
  group_by(item = item_cd_12months) %>%
  summarise(
    T_hat = survey_total(expenditure, na.rm = TRUE, vartype = c("se", "cv")),
    M_hat = survey_mean(expenditure, na.rm = TRUE, vartype = c("se", "cv"))
  )

tab_02 %>%
  transmute(
    item = as_factor(item),
    T_hat = round(T_hat),
    T_hat_cv = round(T_hat_cv * 100, 2),
    M_hat = round(M_hat),
    M_hat_cv = round(M_hat_cv * 100, 2)
  ) %>% data.frame() %>% 
   kable(format = "pipe")
```



|item                                                                               |       T_hat| T_hat_cv| M_hat| M_hat_cv|
|:----------------------------------------------------------------------------------|-----------:|--------:|-----:|--------:|
|1. Clothes/shoes/fabric for MEN (18 years and older)                               | 14831623627|     5.16|   739|     5.10|
|2. Clothes/shoes/fabric for WOMEN (18 years and older)                             | 12372041190|     4.61|   617|     4.58|
|3. Clothes/shoes/fabric for BOYS (less than 18 years)                              |  8240485360|     4.18|   411|     3.96|
|4. Clothes/shoes/fabric for GIRLS (less than 18 years)                             |  7093344006|     4.18|   353|     4.05|
|5. Kitchen equipment (cooking pots, etc.)                                          |  1546185290|     9.68|    77|     9.64|
|6. Linens (sheets, towels,blankets)                                                |  3948547743|     7.58|   197|     7.53|
|7. Furniture                                                                       |  3204286706|    14.43|   160|    14.38|
|8. Lamp/torch/solare power                                                         |  1364016013|    12.61|    68|    12.58|
|9. Ceremonial expenses                                                             | 26850995607|     6.39|  1338|     6.23|
|10. Contributions to informal social security institutions (inc. IDDIR, mahiber..) |  2939856749|     9.22|   146|     9.20|
|11. Donations to religious institutions (Incl. churches and mosques..)             |  3238210354|    10.25|   161|     9.89|

